/*
 * Copyright (C) 2015  Universidade de Aveiro, DETI/IEETA, Bioinformatics Group - http://bioinformatics.ua.pt/
 *
 * This file is part of Dicoogle/dicoogle-webcore.
 *
 * Dicoogle/dicoogle-webcore is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Dicoogle/dicoogle-webcore is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Dicoogle.  If not, see <http://www.gnu.org/licenses/>.
 */
"use strict";define("dicoogle-webcore",function(a){function b(a){var b=Object.prototype.toString;return"[object Array]"===b.call(a)}function c(a){var b=Object.prototype.toString;return"[object Function]"===b.call(a)}function d(b){var d=j[b.dicoogle["slot-id"]];return d?void h(b.name,function(){setTimeout(function(){console.log("Requiring ",b.name,"..."),a([b.name],function(a){console.log("Obtained, reading ..."),c(a)?e(new a,b.name):console.error("Plugin module is not a function! ",a)})},200)}):void console.error("Unexistent slot ID ",b.dicoogle["slot-id"],"!")}function e(a,b){if("object"!=typeof a||"function"!=typeof a.render)return void console.error("Dicoogle web UI plugin ",b," is corrupted or invalid: ",a);var c=l[b],d=c.dicoogle["slot-id"];if("result"===d&&"function"!=typeof a.onResult)return void console.error("Dicoogle web UI plugin ",b," does not provide onResult");console.log("Executed plugin:"+b),a.Name=b,a.SlotId=d,a.Caption=c.dicoogle.caption||b,k[b]=a,j[d].attachPlugin(a);for(var e=0;e<n.load.length;e++)n.load[e](b,d);if("query"===d)for(var e=0;e<n.loadQuery.length;e++)n.loadQuery[e](b);else if("result"===d)for(var e=0;e<n.loadResult.length;e++)n.loadResult[e](b);else if("menu"===d)for(var e=0;e<n.loadMenu.length;e++)n.loadMenu[e](b)}function f(a,b,c){var d=j.result;if(!d)return void console.error("Cannot show results without a result slot.");for(var e=0;e<d.attachments.length;e++)d.attachments[e].onResult(a,b,c);for(var e=0;e<n.result.length;e++)n.result[e](a,b,c)}function g(a,c,d){var e=m;e+=b(c[a])?a.join("/"):a;var f="?";if("string"==typeof c)f+=c;else{var g=[];for(var h in c)if(b(c[h]))for(var i=0;i<c[h].length;i++)g.push(h+"="+encodeURIComponent(c[h][i]));else g.push(h+"="+encodeURIComponent(c[h]));f+=g.join("&")}e+=f;var j="undefined"!=typeof XDomainRequest?new XDomainRequest:new XMLHttpRequest;j.onreadystatechange=function(){if(4===j.readyState){if(200!==j.status)return void d({code:"SERVER-"+j.status,message:j.statusText},null);var a=j.getResponseHeader("Content-Type"),b=a;if(-1!==b.indexOf(";")&&(b=b.split(";")[0]),"application/json"===b){var c=JSON.parse(j.responseText);d(null,c)}else{var c={type:a,text:j.responseText};d(null,c)}}},j.open("GET",e,!0),j.send()}function h(a,b){var c=document.createElement("script"),d=document.getElementsByTagName("script")[0];c.async=1,d.parentNode.insertBefore(c,d);var e=function(a,d){(d||!c.readyState||/loaded|complete/.test(c.readyState))&&(c.onload=c.onreadystatechange=null,c=void 0,d||b&&b())};c.onload=c.onreadystatechange=e,c.src=m+"webui?module="+a+"&process=false"}var i={},j={},k={},l={},m="",n={load:[],loadMenu:[],loadQuery:[],loadResult:[],result:[]};i.addEventListener=function(a,b){var c=n[a];return c?void c.push(b):void console.error("Illegal DicoogleWeb event ",a)},i.addResultListener=function(a){n.result.push(a)},i.addPluginLoadListener=function(a){n.load.push(a)},i.addMenuPluginLoadListener=function(a){n.loadMenu.push(a)},i.addQueryPluginLoadListener=function(a){n.loadQuery.push(a)},i.addResultPluginLoadListener=function(a){n.loadResult.push(a)},i.init=function(a){m="","string"==typeof a&&(m=a,"/"!==m[m.length-1]&&(m+="/")),j={},k={},l={},i.updateSlots()},i.updateSlots=function(){if("object"!=typeof document)throw"no DOM environment!";console.log("Initializing Dicoogle web core ...");for(var a=document.getElementsByTagName("dicoogle-slot"),b=0;b<a.length;b++)i.loadSlot(a[b]);i.fetchPlugins(Object.keys(j))},i.loadSlot=function(a){var b=a.attributes;if(!b["data-slot-id"])return void console.error("Dicoogle web UI slot lacking id attribute!");var c=b["data-slot-id"].value;return j[c]=new this.WebUISlot(c,a),console.log("Loaded Dicoogle slot",c),c},i.fetchPlugins=function(a){console.log("Fetching Dicoogle web UI plugin descriptors ...");var b="webui";g(b,{"slot-id":a},function(a,b){if(a)return void console.error("Failed to fetch plugin descriptors:",a);for(var c=b.plugins,e=0;e<c.length;e++)l[c[e].name]=c[e],d(c[e])})},i.issueQuery=function(a,b,c){b=b||{},b.query=a;var d=new Date,e=b.overrideService||"search";g(e,b,function(a,e){return a?void c(a,null):(f(e,d,b),void c(null,e))})},i.request=function(a,b,c){var d="object"==typeof b?b:{},e="function"==typeof b?b:c;return"function"!=typeof e?void console.error("invalid call to DicoogleWeb.request : a callback function is required"):void g(a,d,e)},i.WebUISlot=function(a,b){this.id=a,this.dom=b,this.attachments=[],this.attachPlugin=function(a){if(a.SlotId!==this.id)return void console.error("Attempt to attach plugin "+a.Name+" to the wrong slot");var b=this.dom;0===this.attachments.length&&(b.innerHTML=""),this.attachments.length>0&&b.appendChild(document.createElement("hr")),b.appendChild(a.render()),this.attachments.push(a),a.TabIndex=this.attachments.length-1,a.Slot=this},this.refresh=function(){var a=this.dom;a.innerHTML="";for(var b=0;b<this.attachments.length;b++)b>0&&a.appendChild(document.createElement("hr")),a.appendChild(this.attachments[b].render())}};var o=function(){var a=document.registerElement("dicoogle-slot",{prototype:Object.create(HTMLDivElement.prototype,{slotId:{get:function(){return this.attributes["data-slot-id"]?this.attributes["data-slot-id"].value:null}},createdCallback:{value:function(){}},attachedCallback:{value:function(){var a=this.attributes["data-slot-id"];return a&&a.value&&""!==a?void 0:void console.error("Dicoogle slot contains illegal data-slot-id!")}},detachedCallback:{value:function(){}}})});return console.log("Registered HTMLDicoogleSlotElement"),a}();return i.HTMLDicoogleSlotElement=o,console.log("Associated HTMLDicoogleSlotElement to DicoogleWeb"),i});