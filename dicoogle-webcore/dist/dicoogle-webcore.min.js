/*
 * Copyright (C) 2015  Universidade de Aveiro, DETI/IEETA, Bioinformatics Group - http://bioinformatics.ua.pt/
 *
 * This file is part of Dicoogle/dicoogle-webcore.
 *
 * Dicoogle/dicoogle-webcore is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Dicoogle/dicoogle-webcore is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Dicoogle.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(a,b){if("object"==typeof exports)module.exports=b(require,exports,module);else if("function"==typeof define&&define.amd)define("dicoogle-webcore",["require","exports","module"],b);else{var c=function(b){return a[b]},d=a,e={exports:d};a.DicoogleWebcore=b(c,d,e)}}(this,function(a,b,c){"use strict";return c.exports=function(){function a(a){return"[object Array]"===m.call(a)}function b(a){return"[object Function]"===m.call(a)}function c(a){var c=h[a.dicoogle["slot-id"]];return c?void f(a.name,function(){var c=a.name;console.log("Loaded module ",c),b(g.constructors[c])||console.error("The loaded module",c,"is not a function!")}):void console.error("Unexistent slot ID ",a.dicoogle["slot-id"],"!")}function d(a,b,c){var d=h.result;if(!d)return void console.error("Cannot show results without a result slot.");for(var e=0;e<d.attachments.length;e++)d.attachments[e].onResult(a,b,c);for(var e=0;e<l.result.length;e++)l.result[e](a,b,c)}function e(b,c,d){var e=k;e+=a(c[b])?b.join("/"):b;var f="?";if("string"==typeof c)f+=c;else{var g=[];for(var h in c)if(a(c[h]))for(var i=0;i<c[h].length;i++)g.push(h+"="+encodeURIComponent(c[h][i]));else g.push(h+"="+encodeURIComponent(c[h]));f+=g.join("&")}e+=f;var j="undefined"!=typeof XDomainRequest?new XDomainRequest:new XMLHttpRequest;j.onreadystatechange=function(){if(4===j.readyState){if(200!==j.status)return void d({code:"SERVER-"+j.status,message:j.statusText},null);var a=j.getResponseHeader("Content-Type"),b=a;if(-1!==b.indexOf(";")&&(b=b.split(";")[0]),"application/json"===b){var c=JSON.parse(j.responseText);d(null,c)}else{var c={type:a,text:j.responseText};d(null,c)}}},j.open("GET",e,!0),j.send()}function f(a,b){var c=document.createElement("script"),d=document.getElementsByTagName("script")[0];c.async=1,d.parentNode.insertBefore(c,d);var e=function(a,d){(d||!c.readyState||/loaded|complete/.test(c.readyState))&&(c.onload=c.onreadystatechange=null,c=void 0,d||b&&b())};c.onload=c.onreadystatechange=e,c.src=k+"webui?module="+a+"&process=true"}var g={constructors:{}},h={},i={},j={},k=null,l={load:[],loadMenu:[],loadQuery:[],loadResult:[],result:[]};g.addEventListener=function(a,b){var c=l[a];return c?void c.push(b):void console.error("Illegal DicoogleWeb event ",a)},g.addResultListener=function(a){l.result.push(a)},g.addPluginLoadListener=function(a){l.load.push(a)},g.addMenuPluginLoadListener=function(a){l.loadMenu.push(a)},g.addQueryPluginLoadListener=function(a){l.loadQuery.push(a)},g.addResultPluginLoadListener=function(a){l.loadResult.push(a)},g.init=function(a){k="","string"==typeof a&&(k=a,"/"!==k[k.length-1]&&(k+="/")),h={},i={},j={},g.updateSlots()},g.updateSlots=function(){if("object"!=typeof document)throw"no DOM environment!";console.log("Initializing Dicoogle web core ...");for(var a=document.getElementsByTagName("dicoogle-slot"),b=0;b<a.length;b++)g.loadSlot(a[b]);var c=Object.keys(h);Object.keys(i).length!==c.length&&g.fetchPlugins(c)},g.loadSlot=function(a){var b=a.attributes;if(!b["data-slot-id"])return console.error("Dicoogle web UI slot has no data-slot-id attribute!"),null;var c=b["data-slot-id"].value;return h[c]=new this.WebUISlot(c,a),console.log("Loaded Dicoogle slot",c),c},g.fetchPlugins=function(a){console.log("Fetching Dicoogle web UI plugin descriptors ...");var b="webui";e(b,{"slot-id":a},function(a,b){if(a)return void console.error("Failed to fetch plugin descriptors:",a);for(var d=b.plugins,e=0;e<d.length;e++)j[d[e].name]=d[e],c(d[e])})},g.issueQuery=function(a,b,c){b=b||{},b.query=a;var f=new Date,g=b.overrideService||"search";e(g,b,function(a,e){return a?void c(a,null):(d(e,f,b),void c(null,e))})},g.request=function(a,b,c){var d="object"==typeof b?b:{},f="function"==typeof b?b:c;return"function"!=typeof f?void console.error("invalid call to DicoogleWeb.request : a callback function is required"):void e(a,d,f)},g.onRegister=function(a,b){if("object"!=typeof a||"function"!=typeof a.render)return void console.error("Dicoogle web UI plugin ",b," is corrupted or invalid: ",a);var c=j[b],d=c.dicoogle["slot-id"];if("result"===d&&"function"!=typeof a.onResult)return void console.error("Dicoogle web UI plugin ",b," does not provide onResult");console.log("Executed plugin: ",b),a.Name=b,a.SlotId=d,a.Caption=c.dicoogle.caption||b,i[b]=a,h[d].attachPlugin(a);for(var e=0;e<l.load.length;e++)l.load[e]({name:b,slotId:d,caption:a.Caption});if("query"===d)for(var e=0;e<l.loadQuery.length;e++)l.loadQuery[e]({name:b,slotId:d,caption:a.Caption});else if("result"===d)for(var e=0;e<l.loadResult.length;e++)l.loadResult[e]({name:b,slotId:d,caption:a.Caption});else if("menu"===d)for(var e=0;e<l.loadMenu.length;e++)l.loadMenu[e]({name:b,slotId:d,caption:a.Caption})},g.WebUISlot=function(a,b){this.id=a,this.dom=b,this.attachments=[],this.dom.className="dicoogle-webcore-"+this.id,this.attachPlugin=function(a){if(a.SlotId!==this.id)return void console.error("Attempt to attach plugin ",a.Name," to the wrong slot");0===this.attachments.length&&(this.dom.innerHTML="");var b=document.createElement("div");b.className=this.dom.className+"_"+this.attachments.length,this.dom.appendChild(b),a.render(b),this.attachments.push(a),a.TabIndex=this.attachments.length-1,a.Slot=this},this.refresh=function(){var a=this.dom;a.innerHTML="";for(var b=0;b<this.attachments.length;b++){var c=document.createElement("div");c.className=a.className+"_"+b,a.appendChild(c),this.attachments[b].render(c)}}};var m=Object.prototype.toString,n=function(){var a=document.registerElement("dicoogle-slot",{prototype:Object.create(HTMLDivElement.prototype,{slotId:{get:function(){return this.attributes["data-slot-id"]?this.attributes["data-slot-id"].value:null}},createdCallback:{value:function(){}},attachedCallback:{value:function(){var a=this.attributes["data-slot-id"];if(!a||!a.value||""===a)return void console.error("Dicoogle slot contains illegal data-slot-id!");var b=a.value;null===k||h[b]||(g.loadSlot(this),i[b]||g.fetchPlugins([b]))}},detachedCallback:{value:function(){}}})});return console.log("Registered HTMLDicoogleSlotElement"),a}();return g.HTMLDicoogleSlotElement=n,console.log("Associated HTMLDicoogleSlotElement to DicoogleWeb"),g}(),c.exports});